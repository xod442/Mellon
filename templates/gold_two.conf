##
no cli default prefix-modes enable
##

##
## MLAG protocol
##
   protocol mlag

##
## LLDP protocol
##
   lldp

##
## LAG configuration
##
   lacp

##
## VLAN configuration
##
  vlan {{ entrytwo.ilo_vlan_number }}
  vlan {{ entrytwo.management_vlan_number }}
  vlan {{ entrytwo.iscsi_a_vlan_number }}
  vlan {{ entrytwo.iscsi_b_vlan_number }}
  vlan {{ entrytwo.vm_prod_vlan_number }}
  vlan 4000
  vlan 4094


##
## DCBX PFC configuration
##
   dcb priority-flow-control enable force

## Create the Inter-Switch Link
   interface port-channel 200

## Add physical ports to the port-channel <mode active> LACP
   interface ethernet 1/21-1/22 channel-group 200 mode active

## Create VLAN for the ISL
   vlan 4094
   interface vlan 4094 mtu 9216

   # This will not get advertised out of the switch
   interface vlan 4094 ip address 10.100.100.1/30 primary
##
   interface port-channel 200 ipl 1
   interface vlan 4094 ipl 1 peer-address 10.100.100.2
   interface port-channel 200 dcb priority-flow-control mode on force

## Set system MAC
   mlag system-mac 00:00:5E:00:01:5D

## Enable the VIP, needs to be an address on mgmt0 interface subnet
   mlag-vip MLAG-DHCI ip {{ entrytwo.mlag_vip_ip }} /{{ entrytwo.mlag_vip_mask }} force
   no mlag shutdown

##
## Interface Ethernet configuration
## Uplink 802.1Q to customer network port 1/16 on bother switches
##
   interface mlag-port-channel 100

## Add physical ports
   interface ethernet 1/16 mlag-channel-group 100 mode active

## Set mtu
   interface mlag-port-channel 100 mtu 9216 force

## Scope VLANS
   interface mlag-port-channel 100 switchport mode trunk
   interface mlag-port-channel 100 switchport trunk allowed-vlan none
   interface mlag-port-channel 100 switchport trunk allowed-vlan add {{ entrytwo.ilo_vlan_number }}
   interface mlag-port-channel 100 switchport trunk allowed-vlan add {{ entrytwo.management_vlan_number }}
   interface mlag-port-channel 100 switchport trunk allowed-vlan add {{ entrytwo.vm_prod_vlan_number }}
   interface mlag-port-channel 100 no shutdown

   interface ethernet 1/1-1/15 speed auto force

## interface ethernet 1/1 description "dHCI-Server-2-ILO"
   interface ethernet 1/2 description "dHCI-Nimble-MGMT-CA-PORT2"
   interface ethernet 1/3 description "dHCI-Nimble-CB-ISCSI-B"
   interface ethernet 1/5 description "dHCI-Nimble-MGMT-CB-PORT2"
   interface ethernet 1/6 description "dHCI-Nimble-CB-ISCSI-B"
   interface ethernet 1/7 description "shutdown"
   interface ethernet 1/8 description "dHCI-Server-2-MGMT"
   interface ethernet 1/9 description "dHCI-Server-1-ISCSI-B"
   interface ethernet 1/10 description "shutdown"
   interface ethernet 1/11 description "shutdown"
   interface ethernet 1/12 description "dHCI-Server-2-ISCSI-B"
   interface ethernet 1/13 description "shutdown"
   interface ethernet 1/14 description "dHCI-Server-1-VM-PROD"
   interface ethernet 1/15 description "dHCI-Server-3-ISCSI-B"
   interface ethernet 1/16 description "MLAG port channel 100"
   interface ethernet 1/17 description "dHCI-Server-3-VM-PROD"
   interface ethernet 1/18 description "shutdown"
   interface ethernet 1/19 description "shutdown"
   interface ethernet 1/20 description "shutdown"
   interface ethernet 1/21 description "NUMBER 1 LINK TO SWITCH 1"
   interface ethernet 1/22 description "NUMBER 2 LINK TO SWITCH 1"

   interface ethernet 1/1 switchport access vlan {{ entrytwo.ilo_vlan_number }}
   interface ethernet 1/2 switchport access vlan {{ entrytwo.management_vlan_number }}
   interface ethernet 1/3 switchport access vlan {{ entrytwo.iscsi_b_vlan_number }}
   interface ethernet 1/4 switchport access vlan {{ entrytwo.ilo_vlan_number }}
   interface ethernet 1/5 switchport access vlan {{ entrytwo.management_vlan_number }}
   interface ethernet 1/6 switchport access vlan {{ entrytwo.iscsi_b_vlan_number }}
   interface ethernet 1/7 shutdown
   interface ethernet 1/8 switchport access vlan {{ entrytwo.management_vlan_number }}
   interface ethernet 1/9 switchport access vlan {{ entrytwo.iscsi_b_vlan_number }}
   interface ethernet 1/10 shutdown
   interface ethernet 1/11 shutdown
   interface ethernet 1/12 switchport access vlan {{ entrytwo.iscsi_b_vlan_number }}
   interface ethernet 1/13 shutdown
   interface ethernet 1/14 switchport access vlan {{ entrytwo.vm_prod_vlan_number }}
   interface ethernet 1/15 switchport access vlan {{ entrytwo.iscsi_b_vlan_number }}

# port 1/16 is the 25G uplink (more review needed)

   interface ethernet 1/17 shutdown
   interface ethernet 1/18 shutdown

##
## STP configuration
##
   spanning-tree mode rpvst
   spanning-tree port type edge default
   interface ethernet 1/1-1/18 spanning-tree port type edge
   interface mlag-port-channel 100 spanning-tree port type normal
   interface mlag-port-channel 200 spanning-tree port type normal
   spanning-tree vlan {{ entrytwo.ilo_vlan_number }} priority 4096
   spanning-tree vlan {{ entrytwo.management_vlan_number }} priority 4096
   spanning-tree vlan {{ entrytwo.vm_prod_vlan_number }} priority 4096

##
## Network interface configuration
##
   no interface mgmt0 dhcp
   interface mgmt0 ip address {{ entrytwo.mgmt0_switch_2_ip}} /{{ entrytwo.mgmt0_switch_2_mask}}

##
## L3 configuration
##
   interface vlan {{ entrytwo.ilo_vlan_number }} ip address {{ entrytwo.ilo_vlan_ip_2 }}/{{ entrytwo.ilo_vlan_mask_2 }} primary
   interface vlan {{ entrytwo.management_vlan_number }} ip address {{ entrytwo.management_vlan_ip_2 }}/{{ entrytwo.management_vlan_mask_2}} primary
   interface vlan {{ entrytwo.vm_prod_vlan_number }} ip address {{ entrytwo.vm_prod_vlan_ip_2 }}/{{ entrytwo.vm_prod_vlan_mask_2}} primary
   vrf definition mgmt
   ip routing vrf default

##
## LLDP configuration
##
   interface ethernet 1/1-1/15 lldp tlv-select sys-description
   interface ethernet 1/20-1/22 lldp tlv-select sys-description

##
## DCBX Aplication Priority configuration
##
dcb application-priority tcp iscsi 4
dcb priority-flow-control priority 4 enable

##
## IGMP Snooping configuration
##
   ip igmp snooping

##
## Logging configuration
##
   logging monitor events notice

##
## Local user account configuration
##
   username admin password 0 admin
   username monitor password 0 monitor

##
## Other IP configuration
##
   hostname dHCI-Switch-Two
   ip route vrf mgmt 0.0.0.0/0 {{ entrytwo.gateway }}

##
## SNMP configuration
##
   snmp-server vrf default enable force

##
## Persistent prefix mode setting
##

cli default prefix-modes enable
